
---
title: "NCI-60 5-FU Demo"
author: "Tara Eicher"
date: "4/01/2022"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{MultiOmicsGraphPrediction NCI60 5FU}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---
# Set up.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
result_dir <- "~\\Ensemble_5fu_vignette_results"
dir.create(result_dir)
```

# Install the packages.
```{r eval = FALSE}
if(!require("devtools")){
  install.packages("devtools")
}
library("devtools")
if(!require("MultiOmicsGraphPrediction")){
  install_github("ncats/MultiOmicsGraphPrediction")
}
library(MultiOmicsGraphPrediction)
if(!require("IntLIM")){
  install_github("ncats/IntLIM")
}
library(IntLIM)
```

# Import data files.
The files below are used to determine pathway membership. Note that a future version may
automatically integrate tables from RaMP.
```{r}
if(!require(data.table)){
  install.packages("data.table")
}
library(data.table)

analyte <- fread("/Volumes/eichertd$/Thesis/aim_2/analyte.txt", sep = "\t", header = FALSE)
analytehaspathway <- fread("/Volumes/eichertd$/Thesis/aim_2/analytehaspathway.txt", sep = "\t", header = FALSE)
pathway <- fread("/Volumes/eichertd$/Thesis/aim_2/pathway.txt", sep = "\t", header = FALSE)
source <- fread("/Volumes/eichertd$/Thesis/aim_2/source.txt", sep = "\t", header = FALSE)
```

Next, we read in the new data.
```{r}
#dir <- system.file("extdata", package="MultiOmicsGraphPrediction", mustWork=TRUE)
dir <- "/Volumes/eichertd$/Ensemble_prediction/inst/extdata"
# Import training data.
csvfileTrain <- file.path(dir, "nci60_5FU.train.csv")
inputDataTrain <- IntLIM::ReadData(csvfileTrain, class.feat = list(drugscore = "numeric",
                                                                   cancertype = "factor",
                                                                   drug5FU = "numeric"))

# Import testing data.
csvfileTest <- file.path(dir, "nci60_5FU.test.csv")
inputDataTest <- IntLIM::ReadData(csvfileTest, class.feat = list(drugscore = "numeric",
                                                                   cancertype = "factor",
                                                                   drug5FU = "numeric"))
```

# Run IntLIM
```{r}
myres <- IntLIM::RunIntLim(inputData = inputDataTrain,stype="drug5FU",
                                 save.covar.pvals = TRUE, 
                                 outcome = 2, 
                                 independent.var.type = 1, 
                                 continuous = TRUE, covar = "cancertype")
IntLIM::DistPvalues(myres, adjusted = FALSE)
IntLIM::DistRSquared(myres)
IntLIM::InteractionCoefficientGraph(inputResults = myres, 
                                    interactionCoeffPercentile = 0.9,
                                    percentageToPlot = 1)
IntLIM::pvalCoefVolcano(inputResults = myres, inputData = inputDataTrain,
                        pvalcutoff = 0.99)
plot(density(myres@interaction.pvalues), xlab = "Interaction Term Unadjusted p-value", main = "")
plot(density(myres@interaction.adj.pvalues), xlab = "Interaction Term Adjusted p-value", main = "")
plot(density(myres@interaction.coefficients), xlab = "Interaction Term Coefficient", main = "")
plot(density(myres@model.rsquared), xlab = "Model R-squared", main = "")
```

# Filter Results and Create Co-Regulation Graph
Don't actually filter anything. Just output the results in a reasonable format so that we can peruse them.
In a co-regulation graph, nodes are analytes (genes and metabolites) and edges indicate
a significant phenotype-dependent association between the analytes.
```{r}
myres.all <- IntLIM::ProcessResults(inputResults = myres, inputData = inputDataTrain, 
                                       pvalcutoff = 1, rsquaredCutoff = 0)
IntLIM::OutputResults(inputResults=myres.all,filename=paste(result_dir,
                                                                    "nci60Data_5FU_Results.csv"
                                                                    , sep = "/"))
# Build graph.
coreg.all <- MultiOmicsGraphPrediction::BuildCoRegulationGraph(myres.all)
MultiOmicsGraphPrediction::PlotCoRegulationGraph(coreg.all, "All 5-FU Dependent Pairwise Associations (NCI-60)", saveInFile = NULL, vertices = NULL)
```
Filter by R^2 only.
```{r}
myres.r2 <- IntLIM::ProcessResults(inputResults = myres, inputData = inputDataTrain, 
                                       pvalcutoff = 1, rsquaredCutoff = 0.4)
# Build graph.
coreg.r2 <- MultiOmicsGraphPrediction::BuildCoRegulationGraph(myres.r2)
MultiOmicsGraphPrediction::PlotCoRegulationGraph(coreg.r2, "5-FU Dependent Pairwise Associations (NCI-60, R^2 > 0.6)", saveInFile = NULL, vertices = NULL)
```
Filter by interaction coefficient only.
```{r}
myres.icoef <- IntLIM::ProcessResults(inputResults = myres, inputData = inputDataTrain, 
                                       pvalcutoff = 1, rsquaredCutoff = 0, interactionCoeffPercentile = 0.1)
# Build graph.
coreg.icoef <- MultiOmicsGraphPrediction::BuildCoRegulationGraph(myres.icoef)
MultiOmicsGraphPrediction::PlotCoRegulationGraph(coreg.icoef, "5-FU Dependent Pairwise Associations (NCI-60, Icoef perc > 0.1)", saveInFile = NULL, vertices = NULL)
```
Filter by unadjusted p-value only.
```{r}
myres.pval <- IntLIM::ProcessResults(inputResults = myres, inputData = inputDataTrain, 
                                       pvalcutoff = 0.5, rsquaredCutoff = 0, interactionCoeffPercentile = 0)
# Build graph.
coreg.pval <- MultiOmicsGraphPrediction::BuildCoRegulationGraph(myres.pval)
MultiOmicsGraphPrediction::PlotCoRegulationGraph(coreg.pval, "5-FU Dependent Pairwise Associations (NCI-60, pval < 0.5)", saveInFile = NULL, vertices = NULL)
```
Filter by all. When we do this, we get the following 12 pairs:
1. FH and malic acid (which have a known reaction in RaMP)
2. dUTP and ME1 (ME2 interacts with DUT [enzyme involved in dUTP synthesis] to increase mtDNA - Wang 2021)
3. dUTP and PDE5A (PDE5A inhibition decreases TUNEL positivity, i.e. it reduces the DNA breakage and prevents dUTP from binding to the DNA - Haider 2010)
4. BHMT and citric acid (?)
5. IL4I1 and dUTP (?)
6. TNFSF10 and citric acid (?)
7. TNFSF10 and dUTP (TNFSF10 induces apoptosis)
8. MDH1 and dUTP (?)
9. HS3ST3B1 and dUTP (?)
10. APRT and dUTP (?)
11. TP53 and cysteine (which have a known reaction in RaMP)
12. PHYH and dUTP (?)
13. FH and cysteine (which have a known reaction in RaMP)
14. UPP2 and dUTP
```{r}
myres.sig <- IntLIM::ProcessResults(inputResults = myres, inputData = inputDataTrain, 
                                       pvalcutoff = 0.5, rsquaredCutoff = 0.4, interactionCoeffPercentile = 0.1)

# Build graph.
coreg.sig <- MultiOmicsGraphPrediction::BuildCoRegulationGraph(myres.sig)
MultiOmicsGraphPrediction::PlotCoRegulationGraph(coreg.sig, "5-FU Dependent Pairwise Associations (NCI-60, Filtered)", saveInFile = NULL, vertices = NULL)
```
# Check Stats of "Positive Control" Pairs.
```{r}
metabolites_of_interest <- make.names(c(rep("2'-deoxyuridine 5'-triphosphate", 7), rep("citric acid", 11),
                             rep("malic acid", 6), rep("succinate", 9)))
genes_of_interest <- make.names(c(c("FURIN", "UMPS", "UPP1", "UPP2", "UCK1", "RRM2", "TYMS"),
                       c("CNDP1", "APRT", "SLCO2B1", "CLYBL", "BHMT", "PDE5A", "IL4I1", "HS3ST3A1", "HS3ST3B1", "OR10H3"),
                       c("MDH2", "FH", "ME2", "ME1", "ME3", "MDH1"),
                       c("TMLHE", "ALKBH2", "PHYH", "P4HA2", "P4HA1", "BBOX1", "PLOD1", "PLOD2", "PLOD3", "P3H1")))
pairs_of_interest <- paste(genes_of_interest, metabolites_of_interest, sep = "__")
myres.all <- IntLIM::ProcessResults(inputResults = myres, inputData = inputDataTrain, 
                                       pvalcutoff = 1, rsquaredCutoff = 0, interactionCoeffPercentile = 0)
myres.pairs <- myres.all[pairs_of_interest,]
View(myres.pairs)
plot(density(myres.pairs$interaction_coeff))
lines(density(myres.all$interaction_coeff), col = "red")

plot(density(myres.pairs$Pval))
lines(density(myres.all$Pval, col = "red"), col = "red")

plot(density(myres.pairs$rsquared))
lines(density(myres.all$rsquared, col = "red"), col = "red")
```

# Run Pairwise Prediction.
```{r}
# Run pairwise prediction.
pred <- MultiOmicsGraphPrediction::RunPairwisePrediction(inputResults = myres.sig, 
                                                         inputData = inputDataTrain,
                                                         stype = "drug5FU",
                                                         independentVarType = 1,
                                                         outcomeType = 2)
```

## Project Predictions
```{r plot graph}
# Project graph.
projectedGraph <- MultiOmicsGraphPrediction::ProjectPredictionsOntoGraph(coRegulationGraph = coreg.sig,
                                                                         predictions = pred)
MultiOmicsGraphPrediction::PlotGraphPredictions(graph = projectedGraph, 
                                                inputData = inputDataTrain,
                                                stype = "drug5FU")
```

## Create Model Input
```{r model input}
# Create input.
modelInput <- MultiOmicsGraphPrediction::FormatInput(predictionGraphs = projectedGraph, 
                                                     coregulationGraph = coreg.sig,
                   inputData = inputDataTrain, stype.class = "numeric", stype = "drug5FU",
                   edgeTypeList = c("shared.outcome.analyte", "shared.independent.analyte"))
saveRDS(modelInput,file=paste(result_dir, paste0("nci60_5FUmodelInput.RDS"), sep = "\\"))
```

## Compute Importance Metrics.
```{r importance}
# Format the pathway-related files appropriately.
colnames(analytehaspathway) <- c("RaMPID", "PathID", "database")
metabMeta <- read.csv(file.path(dir, "fData.metab.nci60.csv"), row.names = 1)
colnames(source) <- c("SourceID", "RaMPID", "source", "type", "commonName", "HMDB_status", "source2")
MultiOmicsGraphPrediction::PlotSubspaceClusteringDendrogram(inputData = inputDataTrain, eigStep = 1)
MultiOmicsGraphPrediction::PlotSubspaceClusteringHeatmap(inputData = inputDataTrain, eigStep = 1)
importance <- MultiOmicsGraphPrediction::GetAllImportanceMetrics(predictions = pred, 
                                                                 modelInput = modelInput,
                                                                 inputData = inputDataTrain, 
                                                                 metricList = c("pdf"),
                                                                 k = 2, eigStep = 1,
                                                                 analytehaspathway = analytehaspathway,
                                                                 analyteNamesOut = metabMeta,
                                                                 source = source)
modelResults <- MultiOmicsGraphPrediction::InitializeGraphLearningModel(modelInput = modelInput,
                                                                        importance = importance)
MultiOmicsGraphPrediction::PlotWeightHeatmap(modelResults = modelResults)
MultiOmicsGraphPrediction::PlotLineGraph(modelResults = modelResults, sampSubset = "UACC.62", weights = FALSE, stype = "drug5FU")
```

```{r}
MultiOmicsGraphPrediction::PlotLineGraph(modelResults = modelResults, sampSubset = "UACC.62", weights = TRUE, stype = "drug5FU")
```

## Calculate information gain for when all terms are included in a composite predictor.

Find the set of composite predictors.
```{r}
pairsPredAll <- MultiOmicsGraphPrediction::ObtainCompositeSubgraphs(modelInput = modelInput)
print(pairsPredAll)
for(pairs in pairsPredAll){
  MultiOmicsGraphPrediction::PlotLineGraph(modelResults = modelResults, subset = pairs, sampSubset = "UACC.62", weights = TRUE, stype = "drug5FU")
}
```

# Compute the information gain with each analyte left out, sequentially.
```{r}
prunedPredictors <- MultiOmicsGraphPrediction::PrunePredictors(compositeSubgraphs = pairsPredAll, IntLIMresults = myres, modelResults = modelResults, inputData = inputDataTrain, verbose = TRUE)
```

# Compare All Information Gains
```{r}
for(pair in unique(unlist(pairsPredAll))){
  compositeModelFull <- MultiOmicsGraphPrediction::CompositePrediction(pairs = pair, 
                                                                   IntLIMresults = myres,
                                                                   modelResults = modelResults,
                                                                   inputData = inputDataTrain)
  print(paste(pair, ComputeInfoGain(pred = unlist(compositeModelFull), trueVal = inputDataTrain@sampleMetaData[,myres@stype])))
}
```