
---
title: "Ensemble NCI-60 Subset Demo"
author: "Tara Eicher"
date: "3/19/2022"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{MultiOmicsGraphPrediction NCI-60 Subset}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---
# Set up.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
result_dir <- "~\\Ensemble_nci60_subset_vignette_results"
dir.create(result_dir)
```

# Install the packages.
```{r eval = FALSE}
if(!require("devtools")){
  install.packages("devtools")
}
library("devtools")
if(!require("MultiOmicsGraphPrediction")){
  install_github("ncats/MultiOmicsGraphPrediction")
}
library(MultiOmicsGraphPrediction)
if(!require("IntLIM")){
  install_github("ncats/IntLIM")
}
library(IntLIM)
```

# Import data files.
First, we read in the RaMP files, which will be used later.
```{r}
if(!require(data.table)){
  install.packages("data.table")
}
library(data.table)

analyte <- fread("/Volumes/eichertd$/Thesis/aim_2/analyte.txt", sep = "\t", header = FALSE)
analytehaspathway <- fread("/Volumes/eichertd$/Thesis/aim_2/analytehaspathway.txt", sep = "\t", header = FALSE)
pathway <- fread("/Volumes/eichertd$/Thesis/aim_2/pathway.txt", sep = "\t", header = FALSE)
source <- fread("/Volumes/eichertd$/Thesis/aim_2/source.txt", sep = "\t", header = FALSE)
```
These data are limited to the metabolites tryptophan, serine, and beta-NADP and also include only the genes known to participate in the following RaMP pathways: "central carbon metabolism in cancer", "WNT Signaling", and "chemical carcinogenesis". First, we filter these metabolites and genes from the original NCI-60 data.
```{r}
# Filter metabolites.
csvorig <- read.csv("/Volumes/eichertd$/IntLIM_vignettes/NCI60_data/metabData.csv", row.names = 1)
csvtrain <- csvorig[c("beta-nicotinamide adenine dinucleotide", "serine", "tryptophan"),1:46]
csvtest <- csvorig[c("beta-nicotinamide adenine dinucleotide", "serine", "tryptophan"),47:57]
write.csv(csvtrain, "/Volumes/eichertd$/Ensemble_prediction/inst/extdata/metabDataNCI60.train.csv")
write.csv(csvtest, "/Volumes/eichertd$/Ensemble_prediction/inst/extdata/metabDataNCI60.test.csv")

# Filter genes.
pathwayList <- c("Central carbon metabolism in cancer", "Wnt signaling pathway", 
                 "Chemical carcinogenesis - DNA adducts", "Chemical carcinogenesis - receptor activation",
                 "Chemical carcinogenesis - reactive oxygen species")
pathwayIds <- pathway$V1[which(pathway$V5 %in% pathwayList)]
pathwayAnalytes <- analytehaspathway$V1[which(analytehaspathway$V2 %in% pathwayIds)]
pathwayGenes <- unlist(lapply(pathwayAnalytes, function(analyte){
  retval <- NA
  if(grepl("_G_", analyte)){
    retval <- analyte
  }
  return(retval)
}))
symbols <- unique(source$V1[intersect(intersect(which(source$V4 == "gene"), which(source$V3 == "gene_symbol")), 
                                      which(source$V2 %in% pathwayGenes))])
symbolsWithoutHeader <- unlist(lapply(symbols, function(gene){
  return(strsplit(gene, ":")[[1]][2])
}))
csvorig <- read.csv("/Volumes/eichertd$/IntLIM_vignettes/NCI60_data/geneData.csv", row.names = 1)
csvtrain <- csvorig[intersect(rownames(csvorig),symbolsWithoutHeader),1:46]
csvtest <- csvorig[intersect(rownames(csvorig),symbolsWithoutHeader),47:57]
write.csv(csvtrain, "/Volumes/eichertd$/Ensemble_prediction/inst/extdata/geneDataNCI60.train.csv")
write.csv(csvtest, "/Volumes/eichertd$/Ensemble_prediction/inst/extdata/geneDataNCI60.test.csv")
```

Next, we read in the new data.
```{r}
 dir <- system.file("extdata", package="MultiOmicsGraphPrediction", mustWork=TRUE)

# Import training data.
csvfileTrain <- file.path(dir, "nci60subsetinput.train.csv")
inputDataTrain <- IntLIM::ReadData(csvfileTrain)

# Import testing data.
csvfileTest <- file.path(dir, "nci60subsetinput.test.csv")
inputDataTest <- IntLIM::ReadData(csvfileTest)
```

# Run IntLIM
```{r}
myres <- IntLIM::RunIntLim(inputData = inputDataTrain,stype="drugscore",
                                 save.covar.pvals = TRUE, 
                                 outcome = 1, 
                                 independent.var.type = 2, 
                                 continuous = TRUE)
```

# Filter Results
```{r}
myres.sig <- IntLIM::ProcessResults(inputResults = myres, inputData = inputDataTrain, 
                                       pvalcutoff = 0.20, rsquaredCutoff = 0.20)
IntLIM::OutputResults(inputResults=myres.sig,filename=paste(result_dir,
                                                                    "nci60DataResults.csv"
                                                                    , sep = "/"))
```

# Create Co-Regulation Graph
In a co-regulation graph, nodes are analytes (genes and metabolites) and edges indicate
a significant phenotype-dependent association between the analytes.
```{r}
# Build graph.
coreg <- MultiOmicsGraphPrediction::BuildCoRegulationGraph(myres.sig)
PlotCoRegulationGraph(coreg, "NCI-60 Subset Graph", saveInFile = NULL, vertices = NULL)
```

# Run Pairwise Prediction.
```{r}
# Run pairwise prediction.
pred <- MultiOmicsGraphPrediction::RunPairwisePrediction(inputResults = myres.sig, 
                                                         inputData = inputDataTrain,
                                                         stype = "drugscore")
```

## Project Predictions
```{r plot graph}
# Project graph.
projectedGraph <- MultiOmicsGraphPrediction::ProjectPredictionsOntoGraph(coRegulationGraph = coreg,
                                                                         predictions = pred)
MultiOmicsGraphPrediction::PlotGraphPredictions(projectedGraph, inputDataTrain, saveInDir = NULL, 
                                 vertices = NULL, truncateTo = 4, includeLabels = TRUE,
                                 cutoffs = NULL, vertexSize = 10)
```

## Create Model Input
```{r model input}
# Create input.
modelInput <- MultiOmicsGraphPrediction::FormatInput(predictionGraphs = projectedGraph, 
                                                     coregulationGraph = coreg,
                   inputData = inputDataTrain, stype.class = "numeric", stype = "drugscore",
                   edgeTypeList = c("shared.outcome.analyte", "shared.independent.analyte"))
saveRDS(modelInput,file=paste(result_dir, paste0("nci60modelInput.RDS"), sep = "\\"))
MultiOmicsGraphPrediction::PlotLineGraph(modelResults = modelResults, weights = FALSE, stype = "drugscore")
```

## Compute Importance Metrics.
```{r importance}
# Format the pathway-related files appropriately.
colnames(analytehaspathway) <- c("RaMPID", "PathID", "database")
metabMeta <- read.csv(file.path(dir, "fData.metab.nci60.csv"), row.names = 1)
colnames(source) <- c("SourceID", "RaMPID", "source", "type", "commonName", "HMDB_status", "source2")
MultiOmicsGraphPrediction::PlotSubspaceClusteringDendrogram(inputData = inputDataTrain, eigStep = 1)
MultiOmicsGraphPrediction::PlotSubspaceClusteringHeatmap(inputData = inputDataTrain, eigStep = 1)
importance <- MultiOmicsGraphPrediction::GetAllImportanceMetrics(predictions = pred, 
                                                                 modelInput = modelInput,
                                                                 inputData = inputDataTrain, 
                                                                 metricList = c("pdf", 
                                                                                "localerr",
                                                                                "pathway"),
                                                                 k = 2, eigStep = 1,
                                                                 analytehaspathway = analytehaspathway,
                                                                 analyteNamesOut = metabMeta,
                                                                 source = source)
#modelInput <- MultiOmicsGraphPrediction::InitializeWeights(modelInput = modelInput,
#                                                           importance = importance)
modelResults <- MultiOmicsGraphPrediction::InitializeGraphLearningModel(modelInput = modelInput,
                                                                        importance = importance)
modelResultsPDF <- MultiOmicsGraphPrediction::InitializeGraphLearningModel(modelInput = modelInput,
                                                                        importance = importance,
                                                                        initialImportanceWeights = c(1,0,0))
modelResultsLocal <- MultiOmicsGraphPrediction::InitializeGraphLearningModel(modelInput = modelInput,
                                                                        importance = importance,
                                                                        initialImportanceWeights = c(0,1,0))
MultiOmicsGraphPrediction::PlotWeightHeatmap(modelResults = modelResults)
MultiOmicsGraphPrediction::PlotWeightHeatmap(modelResults = modelResultsPDF)
MultiOmicsGraphPrediction::PlotWeightHeatmap(modelResults = modelResultsLocal)
```

```{r}
MultiOmicsGraphPrediction::PlotLineGraph(modelResults = modelResults, weights = TRUE, stype = "drugscore")
```

## Calculate information gain for when all terms are included in a composite predictor.

Find the set of composite predictors.
```{r}
pairsPredAll <- MultiOmicsGraphPrediction::ObtainCompositeModels(modelInput = modelInput)
compositeModelFull <- MultiOmicsGraphPrediction::CompositePrediction(pairs = unlist(pairsPredAll), 
                                                                     IntLIMresults = myres,
                                                                     modelResults = modelResults,
                                                                     inputData = inputDataTrain)
compositeModelFullPDF <- MultiOmicsGraphPrediction::CompositePrediction(pairs = unlist(pairsPredAll), 
                                                                     IntLIMresults = myres,
                                                                     modelResults = modelResultsPDF,
                                                                     inputData = inputDataTrain)
compositeModelFullLocal <- MultiOmicsGraphPrediction::CompositePrediction(pairs = unlist(pairsPredAll), 
                                                                     IntLIMresults = myres,
                                                                     modelResults = modelResultsLocal,
                                                                     inputData = inputDataTrain)
```

```{r}
importantPredictors <- MultiOmicsGraphPrediction::PrunePredictors(pairs = pairsPredAll, 
                                                                  IntLIMresults = myres,
                                                                  modelResults = modelResults, 
                                                                  inputData = inputDataTrain)
#print(importantPredictors)
MultiOmicsGraphPrediction::PlotLineGraph(modelResults = modelResults, subset = unlist(c(importantPredictors[[1]]$modelPairs,
                                                                                        importantPredictors[[2]]$modelPairs)), 
                                         weights = TRUE, stype = "drugscore")
```

# Compute the final prediction.
```{r}
compositeModel1 <- MultiOmicsGraphPrediction::CompositePrediction(pairs = importantPredictors[[1]]$modelPairs, 
                                                                     IntLIMresults = myres,
                                                                     modelResults = modelResults,
                                                                     inputData = inputDataTrain) 
compositeModel2 <- MultiOmicsGraphPrediction::CompositePrediction(pairs = importantPredictors[[2]]$modelPairs, 
                                                                     IntLIMresults = myres,
                                                                     modelResults = modelResults,
                                                                     inputData = inputDataTrain) 
avgCompositeModel <- (compositeModel1 + compositeModel2) / 2
avgCompositeModel[which(is.nan(compositeModel1))] <- compositeModel2[which(is.nan(compositeModel1))]
avgCompositeModel[which(is.nan(compositeModel2))] <- compositeModel1[which(is.nan(compositeModel2))]

compositeModelFull1 <- MultiOmicsGraphPrediction::CompositePrediction(pairs = pairsPredAll[[1]], 
                                                                     IntLIMresults = myres,
                                                                     modelResults = modelResults,
                                                                     inputData = inputDataTrain)
compositeModelFull2 <- MultiOmicsGraphPrediction::CompositePrediction(pairs = pairsPredAll[[1]], 
                                                                     IntLIMresults = myres,
                                                                     modelResults = modelResults,
                                                                     inputData = inputDataTrain)

plot(compositeModel1, modelResults@model.input@true.phenotypes, ylab = "True Phenotypes", xlab = "Predicted Phenotypes (LRP6 --> beta-NAD)")
plot(compositeModelFull1, modelResults@model.input@true.phenotypes, ylab = "True Phenotypes", xlab = "Predicted Phenotypes (beta-NAD)")
plot(compositeModel2, modelResults@model.input@true.phenotypes, ylab = "True Phenotypes", xlab = "Predicted Phenotypes (Serine)")
```

# Re-Do the same prediction with the weights of each measurement type being given influence alone.
```{r}
importantPredictorsPDF <- MultiOmicsGraphPrediction::PrunePredictors(pairs = pairsPredAll, 
                                                                  IntLIMresults = myres,
                                                                  modelResults = modelResultsPDF, 
                                                                  inputData = inputDataTrain)
MultiOmicsGraphPrediction::PlotLineGraph(modelResults = modelResultsPDF, 
                                         weights = TRUE, stype = "drugscore")
```
```{r}
#print(importantPredictors)
MultiOmicsGraphPrediction::PlotLineGraph(modelResults = modelResultsPDF, subset = unlist(importantPredictorsPDF[[1]]$modelPairs), 
                                         weights = TRUE, stype = "drugscore")
```

```{r}
compositeModel1 <- MultiOmicsGraphPrediction::CompositePrediction(pairs = importantPredictorsPDF[[1]]$modelPairs, 
                                                                     IntLIMresults = myres,
                                                                     modelResults = modelResultsPDF,
                                                                     inputData = inputDataTrain) 

compositeModelFull1 <- MultiOmicsGraphPrediction::CompositePrediction(pairs = pairsPredAll[[1]], 
                                                                     IntLIMresults = myres,
                                                                     modelResults = modelResults,
                                                                     inputData = inputDataTrain)

plot(compositeModel1, modelResults@model.input@true.phenotypes, ylab = "True Phenotypes", xlab = "Predicted Phenotypes (beta-NAD Subset)")
plot(compositeModelFull1, modelResults@model.input@true.phenotypes, ylab = "True Phenotypes", xlab = "Predicted Phenotypes (beta-NAD)")
```